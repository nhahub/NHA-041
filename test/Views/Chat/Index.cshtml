@model List<test.Models.ChatMessage>
@using Microsoft.AspNetCore.Identity
@using test.Models
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Chat";
    var currentUserId = UserManager.GetUserId(User);
    var receiverId = ViewBag.ReceiverId as string;
    
    // Animal info from ViewBag
    var animalId = ViewBag.AnimalId as int?;
    var animalName = ViewBag.AnimalName as string;
    var animalType = ViewBag.AnimalType as string;
    var animalAge = ViewBag.AnimalAge as byte?;
    var animalPhoto = ViewBag.AnimalPhoto as string;
    var quoteAlreadySent = ViewBag.QuoteAlreadySent as bool? ?? false;
}

<div class="container mt-5 pt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow border-0 rounded-4 chat-card">
                <div class="card-header bg-pink text-white rounded-top-4 py-3 chat-header">
                    <div class="d-flex align-items-center justify-content-between w-100">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-comments fa-lg me-2"></i>
                            <h5 class="mb-0 fw-bold">Chat with <a asp-controller="Profile" asp-action="Index" asp-route-userId="@receiverId" class="text-white text-decoration-none">@ViewBag.ReceiverName</a></h5>
                        </div>
                        <a href="javascript:history.back()" class="btn btn-sm btn-light text-pink rounded-pill fw-bold">
                            <i class="fas fa-arrow-left me-1"></i> Back
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="chat-messages" class="p-4 chat-messages-area">
                        @if (Model != null && Model.Any())
                        {
                            foreach (var msg in Model)
                            {
                                var isMe = msg.SenderId == currentUserId;
                                <div class="d-flex @(isMe ? "justify-content-end" : "justify-content-start") mb-3">
                                    <div style="max-width: @(msg.Animal != null ? "85%" : "75%");">
                                        @if (msg.Animal != null)
                                        {
                                            <!-- Animal Quote Card -->
                                            <div class="@(isMe ? "bg-pink text-white" : "bg-white text-dark border") p-3 rounded-4 shadow-sm"
                                                 style="@(isMe ? "border-top-right-radius: 0 !important;" : "border-top-left-radius: 0 !important;")">
                                                <div class="d-flex align-items-center gap-3">
                                                    <img src="@msg.Animal.Photo" alt="@msg.Animal.Name" 
                                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; border: 2px solid @(isMe ? "rgba(255,255,255,0.3)" : "#db98b7");">
                                                    <div>
                                                        <div class="fw-bold" style="font-size: 1rem;">
                                                            <i class="fas fa-paw me-1"></i> @msg.Animal.Name
                                                        </div>
                                                        <div style="font-size: 0.85rem; opacity: 0.9;">
                                                            <span class="me-2"><i class="fas fa-tag me-1"></i>@msg.Animal.Type</span>
                                                            @if (msg.Animal.Age.HasValue)
                                                            {
                                                                <span><i class="fas fa-birthday-cake me-1"></i>@msg.Animal.Age years</span>
                                                            }
                                                        </div>
                                                        <div class="mt-1" style="font-size: 0.8rem; opacity: 0.8;">
                                                            <i class="fas fa-heart me-1"></i> Interested in adoption
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mt-2 pt-2" style="border-top: 1px solid @(isMe ? "rgba(255,255,255,0.2)" : "rgba(0,0,0,0.1)");">
                                                    @msg.Message
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <!-- Regular Message -->
                                            <div class="@(isMe ? "bg-pink text-white" : "bg-white text-dark border") p-3 rounded-4 shadow-sm"
                                                 style="@(isMe ? "border-top-right-radius: 0 !important;" : "border-top-left-radius: 0 !important;")">
                                                @msg.Message
                                            </div>
                                        }
                                        <small class="d-block mt-1 text-muted @(isMe ? "text-end" : "text-start")" style="font-size: 0.7em;">
                                            @msg.Time.ToString("hh:mm tt")
                                            @if (isMe)
                                            {
                                                <span class="ms-1">
                                                    @if (msg.read == true)
                                                    {
                                                        <i class="fas fa-check-double text-primary msg-status"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="fas fa-check text-muted msg-status"></i>
                                                    }
                                                </span>
                                            }
                                        </small>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted small mt-5 empty-chat-state">
                                <i class="fas fa-paper-plane fa-3x mb-3 opacity-25"></i>
                                <p>Start the conversation!</p>
                            </div>
                        }
                    </div>

                    <div class="p-3 bg-white border-top chat-input-area">
                        <input type="hidden" id="receiverId" value="@receiverId">
                        
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control form-control-lg border-0 bg-light rounded-pill px-4" placeholder="Type your message..." aria-label="Type your message..." autocomplete="off">
                            <button class="btn btn-pink rounded-circle ms-2 d-flex align-items-center justify-content-center" type="button" id="sendButton" style="width: 48px; height: 48px;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- SignalR Client Library -->
    <script src="~/microsoft/signalr/dist/browser/signalr.js"></script>
    
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();

        const currentUserId = "@currentUserId";
        const receiverId = "@receiverId";
        
        // Animal info for quote message
        const animalId = @(animalId.HasValue ? animalId.Value.ToString() : "null");
        const animalName = "@(animalName ?? "")";
        const animalType = "@(animalType ?? "")";
        const animalAge = @(animalAge.HasValue ? animalAge.Value.ToString() : "null");
        const animalPhoto = "@(animalPhoto ?? "")";
        const quoteAlreadySent = @(quoteAlreadySent ? "true" : "false");

        // Scroll to bottom on load
        const chatBox = document.getElementById("chat-messages");
        chatBox.scrollTop = chatBox.scrollHeight;

        // Receive message as Sender (confirmation)
        connection.on("sendermessage", function (chatMessage) {
            appendMessage(chatMessage, true);
        });

        // Receive message as Receiver
        connection.on("recievermessage", function (chatMessage) {
            appendMessage(chatMessage, false);
            // If the message is from the person we are currently chatting with, mark it as read immediately
            if (chatMessage.senderId === receiverId) {
                 $.post("/Chat/MarkAsRead", { messageId: chatMessage.id });
            }
        });

        // Receive animal quote message as Sender
        connection.on("AnimalQuoteMessage", function (chatMessage, animalData) {
            appendQuoteMessage(chatMessage, animalData, true);
        });

        // Receive animal quote message as Receiver
        connection.on("AnimalQuoteMessageReciever", function (chatMessage, animalData) {
            appendQuoteMessage(chatMessage, animalData, false);
        });

        // Listen for read receipt
        connection.on("messagesRead", function (readerId) {
            if (readerId === receiverId) {
                const checks = document.querySelectorAll('.msg-status.fa-check');
                checks.forEach(icon => {
                    icon.classList.remove('fa-check', 'text-muted');
                    icon.classList.add('fa-check-double', 'text-primary');
                });
            }
        });

        connection.start().then(function () {
            console.log("SignalR Connected!");
            document.getElementById("sendButton").disabled = false;
            
            // Auto-send animal quote message if animalId exists and quote hasn't been sent before
            if (animalId !== null && animalName && !quoteAlreadySent) {
                const autoMessage = `Hi, I'm interested in adopting ${animalName} (${animalType})!`;
                const chatMessage = {
                    SenderId: currentUserId,
                    ReceiverId: receiverId,
                    Message: autoMessage,
                    Time: new Date().toISOString()
                };
                
                connection.invoke("sendmessage", chatMessage, animalId).catch(function (err) {
                    return console.error(err.toString());
                });
            }
        }).catch(function (err) {
            return console.error(err.toString());
        });

        document.getElementById("sendButton").addEventListener("click", sendMessage);
        document.getElementById("messageInput").addEventListener("keypress", function (e) {
            if (e.key === 'Enter') {
                sendMessage(e);
            }
        });

        function sendMessage(event) {
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value;

            if (!receiverId || !message) return;

            const chatMessage = {
                SenderId: currentUserId,
                ReceiverId: receiverId,
                Message: message,
                Time: new Date().toISOString()
            };

            connection.invoke("sendmessage", chatMessage, null).catch(function (err) {
                return console.error(err.toString());
            });
            
            messageInput.value = "";
            event.preventDefault();
        }

        function appendMessage(chatMessage, isMe) {
            // Check if this message has an animal - if so, let appendQuoteMessage handle it
            if (chatMessage.animalId) {
                return; // Will be handled by AnimalQuoteMessage event
            }
            
            const msgDiv = document.createElement("div");
            msgDiv.className = isMe ? "d-flex justify-content-end mb-3" : "d-flex justify-content-start mb-3";
            
            const contentDiv = document.createElement("div");
            contentDiv.style.maxWidth = "75%";

            const bubble = document.createElement("div");
            bubble.className = isMe ? "bg-pink text-white p-3 rounded-4 shadow-sm" : "bg-white text-dark p-3 rounded-4 shadow-sm border";
            
            // Add specific styling for corner radius
            if (isMe) {
                bubble.style.borderTopRightRadius = "0";
            } else {
                bubble.style.borderTopLeftRadius = "0";
            }
            
            bubble.textContent = chatMessage.message; 

            const time = document.createElement("small");
            time.className = "d-block mt-1 text-muted " + (isMe ? "text-end" : "text-start");
            time.style.fontSize = "0.7em";
            
            let timeText = new Date(chatMessage.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
            
            if (isMe) {
                // Add checkmark for sent messages
                time.innerHTML = `${timeText} <span class="ms-1"><i class="fas fa-check text-muted msg-status"></i></span>`;
            } else {
                time.textContent = timeText;
            }

            contentDiv.appendChild(bubble);
            contentDiv.appendChild(time);
            msgDiv.appendChild(contentDiv);
            
            const chatBox = document.getElementById("chat-messages");
            // Remove empty state if exists
            if(chatBox.querySelector('.empty-chat-state')) chatBox.querySelector('.empty-chat-state').remove();
            
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendQuoteMessage(chatMessage, animalData, isMe) {
            const msgDiv = document.createElement("div");
            msgDiv.className = isMe ? "d-flex justify-content-end mb-3" : "d-flex justify-content-start mb-3";
            
            const contentDiv = document.createElement("div");
            contentDiv.style.maxWidth = "85%";

            // Create animal quote card
            const quoteCard = document.createElement("div");
            quoteCard.className = isMe ? "bg-pink text-white p-3 rounded-4 shadow-sm" : "bg-white text-dark p-3 rounded-4 shadow-sm border";
            if (isMe) {
                quoteCard.style.borderTopRightRadius = "0";
            } else {
                quoteCard.style.borderTopLeftRadius = "0";
            }

            quoteCard.innerHTML = `
                <div class="d-flex align-items-center gap-3">
                    <img src="${animalData.photo}" alt="${animalData.name}" 
                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; border: 2px solid ${isMe ? 'rgba(255,255,255,0.3)' : '#db98b7'};">
                    <div>
                        <div class="fw-bold" style="font-size: 1rem;">
                            <i class="fas fa-paw me-1"></i> ${animalData.name}
                        </div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">
                            <span class="me-2"><i class="fas fa-tag me-1"></i>${animalData.type}</span>
                            ${animalData.age ? `<span><i class="fas fa-birthday-cake me-1"></i>${animalData.age} years</span>` : ''}
                        </div>
                        <div class="mt-1" style="font-size: 0.8rem; opacity: 0.8;">
                            <i class="fas fa-heart me-1"></i> Interested in adoption
                        </div>
                    </div>
                </div>
                <div class="mt-2 pt-2" style="border-top: 1px solid ${isMe ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)'};">
                    ${chatMessage.message}
                </div>
            `;

            const time = document.createElement("small");
            time.className = "d-block mt-1 text-muted " + (isMe ? "text-end" : "text-start");
            time.style.fontSize = "0.7em";
            
            let timeText = new Date(chatMessage.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
            
            if (isMe) {
                time.innerHTML = `${timeText} <span class="ms-1"><i class="fas fa-check text-muted msg-status"></i></span>`;
            } else {
                time.textContent = timeText;
            }

            contentDiv.appendChild(quoteCard);
            contentDiv.appendChild(time);
            msgDiv.appendChild(contentDiv);
            
            const chatBox = document.getElementById("chat-messages");
            if(chatBox.querySelector('.empty-chat-state')) chatBox.querySelector('.empty-chat-state').remove();
            
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
}
